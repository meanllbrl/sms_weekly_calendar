<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haftalık Plan</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #ffffff;
            --surface: #ffffff;
            --text: #2b2a27;
            --muted: #8c8b88;
            --border: rgba(0,0,0,0.08);
            --elev-1: 0 1px 2px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);

            --accent-blue: #3b82f6;    --accent-blue-dark: #2563eb;
            --accent-green: #10b981;   --accent-green-dark: #059669;
            --accent-purple: #8b5cf6;  --accent-purple-dark: #7c3aed;
            --accent-orange: #f59e0b;  --accent-orange-dark: #d97706;
            --accent-pink: #ec4899;    --accent-pink-dark: #db2777;
            --accent-red: #ef4444;     --accent-red-dark: #dc2626;
            --accent-teal: #14b8a6;    --accent-teal-dark: #0d9488;
            --accent-indigo: #6366f1;  --accent-indigo-dark: #4f46e5;
            --accent-cyan: #06b6d4;    --accent-cyan-dark: #0891b2;

            --grid-15: rgba(2, 6, 23, 0.04);
            --grid-60: rgba(2, 6, 23, 0.08);
            --available-bg: rgba(16,185,129,0.10);
            --available-border: rgba(16,185,129,0.45);
            --holiday-bg: rgba(14,165,233,0.08);

            --timeline-width: 56px;
            --hour-height: 48px; /* 1 saat = 48px, 15dk = 12px */
            --column-min: 200px; /* ~5% narrower */
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #161616;
                --surface: #191919;
                --text: rgba(255,255,255,0.9);
                --muted: rgba(255,255,255,0.6);
                --border: rgba(255,255,255,0.08);
                --grid-15: rgba(255,255,255,0.05);
                --grid-60: rgba(255,255,255,0.12);
                --available-bg: rgba(16,185,129,0.15);
                --available-border: rgba(16,185,129,0.5);
                --holiday-bg: rgba(14,165,233,0.12);
            }
        }

        body { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; color: var(--text); background: var(--bg); }
        .page { min-height: 100dvh; padding: clamp(8px, 1.5dvh, 16px); display: flex; flex-direction: column; gap: 6px; }

        .calendar-shell { border: 1.5px solid var(--border); border-radius: 14px; overflow: hidden; background: var(--surface); display: grid; grid-template-columns: var(--timeline-width) 1fr; box-shadow: var(--elev-1); }

        .day-headers { display: grid; grid-template-columns: repeat(7, minmax(var(--column-min), 1fr)); position: sticky; top: 0; z-index: 5; background: var(--surface); border-bottom: 1.5px solid var(--border); }
        .day-header { padding: 8px 8px; text-align: center; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); font-size: 10px; }
        .day-header.empty { color: #0891b2; opacity: .9; }

        .timeline { position: relative; }
        .timeline-header { position: sticky; top: 0; height: 34px; background: var(--surface); border-right: 1.5px solid var(--border); }
        .time-grid { position: relative; height: calc(var(--hour-height) * 15); }
        .time-label { position: absolute; left: 0; width: 100%; text-align: right; padding-right: 6px; color: var(--muted); font-size: 9.5px; font-weight: 700; transform: translateY(-50%); }

        .days-container { overflow: auto; position: relative; }
        .days { position: relative; display: grid; grid-template-columns: repeat(7, minmax(var(--column-min), 1fr)); }
        .day { position: relative; height: calc(var(--hour-height) * 15); border-right: 1px solid var(--border); }
        .day:last-child { border-right: none; }
        .day.empty { background: var(--holiday-bg); }

        .day::before { content: ""; position: absolute; inset: 0; background:
            repeating-linear-gradient(to bottom,
                var(--grid-15) 0 1px, transparent 1px calc(var(--hour-height)/4),
                transparent calc(var(--hour-height)/4) calc(var(--hour-height)/4 + 1px),
                var(--grid-15) calc(var(--hour-height)/4) calc(var(--hour-height)/2),
                var(--grid-60) calc(var(--hour-height)/2) calc(var(--hour-height)/2 + 1px),
                transparent calc(var(--hour-height)/2 + 1px) calc(var(--hour-height)*3/4),
                var(--grid-15) calc(var(--hour-height)*3/4) calc(var(--hour-height)*3/4 + 1px),
                transparent calc(var(--hour-height)*3/4 + 1px) var(--hour-height)
            ); pointer-events: none; }

        .event { position: absolute; left: 6px; right: 6px; border-radius: 9px; color: #fff; font-weight: 800; letter-spacing: .01em; box-shadow: 0 3px 14px rgba(0,0,0,.18); display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px 6px; font-size: 10.6px; line-height: 1.1; user-select: none; }
        .event:hover { transform: translateY(-1px); box-shadow: 0 8px 22px rgba(0,0,0,.22); }

        .available { background: var(--available-bg); border: 2px dashed var(--available-border); color: var(--accent-green); box-shadow: none; }
        .event.s0 { background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-dark)); }
        .event.s1 { background: linear-gradient(135deg, var(--accent-green), var(--accent-green-dark)); }
        .event.s2 { background: linear-gradient(135deg, var(--accent-purple), var(--accent-purple-dark)); }
        .event.s3 { background: linear-gradient(135deg, var(--accent-orange), var(--accent-orange-dark)); }
        .event.s4 { background: linear-gradient(135deg, var(--accent-pink), var(--accent-pink-dark)); }
        .event.s5 { background: linear-gradient(135deg, var(--accent-teal), var(--accent-teal-dark)); }
        .event.s6 { background: linear-gradient(135deg, var(--accent-indigo), var(--accent-indigo-dark)); }
        .event.s7 { background: linear-gradient(135deg, var(--accent-red), var(--accent-red-dark)); }
        .event.s8 { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-cyan-dark)); }
        .event.s9 { background: linear-gradient(135deg, #a855f7, #9333ea); }

        .event[data-columns] { width: calc((100% - 12px) / var(--cols)); left: calc(6px + (var(--track) * (100% - 12px) / var(--cols))); right: auto; }

        .nav-btn { display: none; position: absolute; top: 50%; transform: translateY(-50%); height: 32px; width: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface); box-shadow: var(--elev-1); color: var(--text); font-weight: 900; font-size: 18px; align-items: center; justify-content: center; cursor: pointer; z-index: 6; }
        .nav-left { left: 6px; }
        .nav-right { right: 6px; }

        .refresh-btn { position: fixed; bottom: 20px; right: 20px; width: 48px; height: 48px; border-radius: 50%; border: 1.5px solid var(--border); background: var(--surface); box-shadow: var(--elev-1); color: var(--text); font-weight: 900; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.25s ease; }
        .refresh-btn:hover { transform: scale(1.05); box-shadow: var(--elev-2); }
        .refresh-btn.spin { animation: spin 0.7s linear; }
        @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

        @media (max-width: 900px) {
            :root { --column-min: 190px; --timeline-width: 52px; --hour-height: 46px; }
            .event { font-size: 10.2px; padding: 4px 6px; }
        }
        @media (max-width: 560px) {
            :root { --column-min: 170px; --hour-height: 44px; }
            .event { font-size: 9.8px; border-radius: 8px; }
            .nav-btn { display: none; }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="calendar-shell">
            <div class="timeline">
                <div class="timeline-header"></div>
                <div id="timeline" class="time-grid"></div>
            </div>
            <div class="days-container">
                <div id="dayHeaders" class="day-headers"></div>
                <div id="days" class="days"></div>
                <div class="nav-btn nav-left" onclick="prevDay()" title="Önceki Gün">‹</div>
                <div class="nav-btn nav-right" onclick="nextDay()" title="Sonraki Gün">›</div>
            </div>
        </div>
        <button class="refresh-btn" id="refreshBtn" onclick="refreshData()" title="Yenile">↻</button>
    </div>

    <script>
        // Read connection details from URL
        function getUrlParams(){
            const p = new URLSearchParams(window.location.search);
            return { key: p.get('key'), endpoint: p.get('endpoint') };
        }
        function decodeEndpoint(value){
            if(!value) return null;
            try {
                const decoded = atob(value);
                if(decoded.startsWith('http')) return decoded;
            } catch {}
            // accept raw URL too
            if(value.startsWith('http')) return value;
            return null;
        }

        const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
        const DAY_TR = { Monday:'Pazartesi', Tuesday:'Salı', Wednesday:'Çarşamba', Thursday:'Perşembe', Friday:'Cuma', Saturday:'Cumartesi', Sunday:'Pazar' };

        const START_MIN = 8*60;  // 08:00
        const END_MIN = 23*60;   // 23:00
        const HOUR_HEIGHT = () => parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hour-height'));
        const PX_PER_MIN = () => HOUR_HEIGHT()/60;

        function qs(sel,root=document){return root.querySelector(sel)}
        function qsa(sel,root=document){return Array.from(root.querySelectorAll(sel))}
        function timeFromISO(iso){ const d=new Date(iso); return d.getHours()*60+d.getMinutes(); }
        function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
        function minutesToHHMM(m){ const h=Math.floor(m/60); const mm=m%60; return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
        function isMobileOneDay(){ return window.innerWidth <= 560; }

        let activeDayIndex = 0;

        function buildStaticUI(){
            const tl = qs('#timeline');
            tl.innerHTML = '';
            for(let m=START_MIN; m<=END_MIN; m+=30){
                const top = (m-START_MIN)*PX_PER_MIN();
                const isHour = m%60===0;
                const label = `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = 'time-label';
                el.style.top = `${top}px`;
                el.style.fontWeight = isHour? '800' : '700';
                el.style.opacity = isHour? '1' : '.75';
                el.textContent = label;
                tl.appendChild(el);
            }
        }

        // Curated 30-color palette (distinct hues, optimized for white text)
        const PALETTE_BASES = [
            '#003366', '#50C878', '#8B0000', '#FFD700', '#4B0082', '#40E0D0', '#FF8C00', '#228B22', '#C71585', '#4682B4',
            '#654321', '#32CD32', '#2F4F4F', '#FF7F50', '#800000', '#20B2AA', '#B8860B', '#9932CC', '#008B8B', '#E9967A',
            '#006400', '#708090', '#8B4513', '#483D8B', '#A52A2A', '#2E8B57', '#DAA520', '#008080', '#8B008B', '#0B3D91'
        ];

        // Color helpers
        function hexToRgb(hex){
            const h = hex.replace('#','');
            const bigint = parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return {r,g,b};
        }
        function rgbToHsl(r,g,b){
            r/=255; g/=255; b/=255;
            const max = Math.max(r,g,b), min = Math.min(r,g,b);
            let h,s,l = (max+min)/2;
            if(max===min){ h=0; s=0; }
            else {
                const d = max-min;
                s = l>0.5 ? d/(2-max-min) : d/(max+min);
                switch(max){
                    case r: h=(g-b)/d + (g<b?6:0); break;
                    case g: h=(b-r)/d + 2; break;
                    case b: h=(r-g)/d + 4; break;
                }
                h*=60;
            }
            return { h, s: s*100, l: l*100 };
        }
        function hexToHsl(hex){ const {r,g,b}=hexToRgb(hex); return rgbToHsl(r,g,b); }
        function clampNum(v,min,max){ return Math.max(min, Math.min(max, v)); }
        function gradientFromBaseHex(hex){
            const hsl = hexToHsl(hex);
            const h = Math.round(hsl.h);
            const s = Math.round(clampNum(hsl.s*0.95 + 6, 48, 88));
            const startL = 38;  // ensure good white text contrast
            const endL = 28;
            return `linear-gradient(135deg, hsl(${h}, ${s}%, ${startL}%), hsl(${h}, ${s}%, ${endL}%))`;
        }

        // Deterministic unique assignment of palette indices to student names
        const assignedIndexByName = new Map();
        const nameByIndex = new Map();
        const STORAGE_KEY = 'studentColorMapV1';
        function loadStoredMapping(){
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if(!raw) return;
                const obj = JSON.parse(raw);
                const n = PALETTE_BASES.length;
                Object.keys(obj||{}).forEach(name => {
                    const idx = obj[name];
                    if(typeof idx === 'number' && idx>=0 && idx<n && !nameByIndex.has(idx)){
                        assignedIndexByName.set(name, idx);
                        nameByIndex.set(idx, name);
                    }
                });
            } catch {}
        }
        function persistMapping(){
            try {
                const out = {};
                assignedIndexByName.forEach((idx, name) => { out[name] = idx; });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
            } catch {}
        }
        function hashString(str){
            let h = 2166136261 >>> 0; // FNV-1a basis
            for(let i=0;i<str.length;i++){
                h ^= str.charCodeAt(i);
                h = Math.imul(h, 16777619);
            }
            return h >>> 0;
        }
        function assignIndexForName(name){
            if(assignedIndexByName.has(name)) return;
            const n = PALETTE_BASES.length;
            const base = hashString(name) % n;
            const step = 7; // co-prime with 30 to probe evenly
            let idx = base;
            let attempts = 0;
            while(nameByIndex.has(idx) && nameByIndex.get(idx)!==name && attempts < n){
                idx = (idx + step) % n;
                attempts++;
            }
            assignedIndexByName.set(name, idx);
            nameByIndex.set(idx, name);
            persistMapping();
        }
        function preparePaletteFor(names){
            // stable ordering independent of input sequence
            const unique = Array.from(new Set(names)).sort((a,b)=>a.localeCompare(b,'tr'));
            unique.forEach(assignIndexForName);
            persistMapping();
        }
        function gradientForStudent(nameOrId){
            const id = (nameOrId||'').trim() || 'default';
            assignIndexForName(id);
            const idx = assignedIndexByName.get(id) ?? 0;
            return gradientFromBaseHex(PALETTE_BASES[idx]);
        }

        function applyMobileActiveClasses(){
            const headers = qsa('.day-header');
            const cols = qsa('.day');
            headers.forEach((h,i)=>h.classList.toggle('active', i===activeDayIndex));
            cols.forEach((c,i)=>c.classList.toggle('active', i===activeDayIndex));
        }

        function layoutAndRender(sessions){
            const byDay = Object.fromEntries(DAYS.map(d => [d, []]));
            sessions.forEach(s => {
                if(!s.property_weekday || !s.property_hours_start || !s.property_hours_end) return;
                const start = clamp(timeFromISO(s.property_hours_start), START_MIN, END_MIN);
                const end = clamp(timeFromISO(s.property_hours_end), START_MIN, END_MIN);
                if(end<=start) return;
                byDay[s.property_weekday].push({ ...s, start, end });
            });

            // Pre-assign palette indices for all students to ensure stable unique mapping
            const allNames = new Set();
            DAYS.forEach(d => {
                byDay[d].forEach(evt => {
                    const raw = (evt.name||'').trim();
                    if(!raw) return;
                    if(raw.toUpperCase().startsWith('AVAILABLE')) return;
                    const nm = (raw.split('(')[0]||'').trim();
                    if(nm) allNames.add(nm);
                });
            });
            preparePaletteFor(Array.from(allNames));

            const empties = DAYS.map(d => byDay[d].length === 0);
            qs('#dayHeaders').innerHTML = DAYS.map((d,i) => `<div class="day-header ${empties[i]?'empty':''}">${DAY_TR[d]}</div>`).join('');
            qs('#days').innerHTML = DAYS.map((_,i) => `<div class="day ${empties[i]?'empty':''}"></div>`).join('');

            // Column widths: empty days narrower (extra-narrow on mobile)
            const isMobile = window.innerWidth <= 560;
            const cols = DAYS.map((d,i) => {
                if (isMobile) {
                    return empties[i] ? '44px' : 'minmax(var(--column-min), var(--column-min))';
                }
                return empties[i] ? 'minmax(44px, 0.24fr)' : 'minmax(var(--column-min), 1fr)';
            }).join(' ');
            qs('#dayHeaders').style.gridTemplateColumns = cols;
            qs('#days').style.gridTemplateColumns = cols;

            const columns = qsa('.day', qs('#days'));
            DAYS.forEach((day, dayIdx) => {
                const list = byDay[day].sort((a,b)=>a.start-b.start);
                const tracks = [];
                const laid = list.map(evt => { let track=0; while(tracks[track] && tracks[track] > evt.start) track++; tracks[track]=evt.end; return { evt, track }; });
                const colsCount = Math.max(1, tracks.length);
                const col = columns[dayIdx]; col.innerHTML='';
                laid.forEach(({evt, track}) => {
                    const top = (evt.start-START_MIN)*PX_PER_MIN();
                    const height = (evt.end-evt.start)*PX_PER_MIN();
                    const isAvailable = (evt.name||'').trim().toUpperCase().startsWith('AVAILABLE');
                    const name = isAvailable ? 'Müsait' : (evt.name.split('(')[0]||'').trim();
                    const durationMin = evt.end - evt.start;
                    const label = `${name} (${minutesToHHMM(evt.start)}–${minutesToHHMM(evt.end)})`;
                    const tip = `${DAY_TR[day]} • ${minutesToHHMM(evt.start)}–${minutesToHHMM(evt.end)} (${durationMin} dk)`;
                    const div = document.createElement('div');
                    div.className = `event ${isAvailable? 'available' : ''}`;
                    if(!isAvailable){ div.style.background = gradientForStudent(name); }
                    if(colsCount>1){ div.dataset.columns = String(colsCount); div.style.setProperty('--cols', colsCount); div.style.setProperty('--track', track); }
                    div.style.top = `${top+2}px`;
                    div.style.height = `${Math.max(18, height-4)}px`;
                    div.textContent = label;
                    div.title = tip;
                    col.appendChild(div);
                });
            });

            if(isMobileOneDay()) applyMobileActiveClasses();
        }

        async function fetchData(){
            const { key, endpoint } = getUrlParams();
            const url = decodeEndpoint(endpoint);
            if(!key || !url){
                qs('#days').innerHTML = '<div style="padding:12px;color:var(--muted);">Erişim reddedildi</div>';
                qs('#dayHeaders').innerHTML = '';
                return;
            }
            try {
                let res;
                try {
                    res = await fetch(url, { headers: { 'Authorization': `Basic ${key}` } });
                } catch (e) {
                    const proxy = `https://thingproxy.freeboard.io/fetch/${url}`;
                    res = await fetch(proxy, { headers: { 'Authorization': `Basic ${key}` } });
                }
                if(!res.ok) throw new Error('Network');
                const data = await res.json();
                layoutAndRender(data);
            } catch (e) {
                qs('#days').innerHTML = '<div style="padding:12px;color:#dc2626;">Veri yüklenemedi</div>';
                qs('#dayHeaders').innerHTML = '';
            }
        }

        async function refreshData(){
            const btn = qs('#refreshBtn');
            btn.classList.add('spin');
            try {
                await fetchData();
            } finally {
                setTimeout(() => btn.classList.remove('spin'), 600);
            }
        }

        function prevDay(){ activeDayIndex = (activeDayIndex + 6) % 7; applyMobileActiveClasses(); }
        function nextDay(){ activeDayIndex = (activeDayIndex + 1) % 7; applyMobileActiveClasses(); }

        buildStaticUI();
        fetchData();
        window.addEventListener('resize', () => { buildStaticUI(); fetchData(); });
    </script>
</body>
</html>
