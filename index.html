<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haftalık Plan</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #ffffff;
            --surface: #ffffff;
            --text: #2b2a27;
            --muted: #8c8b88;
            --border: rgba(0,0,0,0.08);
            --elev-1: 0 1px 2px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);

            --accent-blue: #3b82f6;    --accent-blue-dark: #2563eb;
            --accent-green: #10b981;   --accent-green-dark: #059669;
            --accent-purple: #8b5cf6;  --accent-purple-dark: #7c3aed;
            --accent-orange: #f59e0b;  --accent-orange-dark: #d97706;
            --accent-pink: #ec4899;    --accent-pink-dark: #db2777;
            --accent-red: #ef4444;     --accent-red-dark: #dc2626;
            --accent-teal: #14b8a6;    --accent-teal-dark: #0d9488;
            --accent-indigo: #6366f1;  --accent-indigo-dark: #4f46e5;
            --accent-cyan: #06b6d4;    --accent-cyan-dark: #0891b2;

            --grid-15: rgba(2, 6, 23, 0.04);
            --grid-60: rgba(2, 6, 23, 0.08);
            --available-bg: rgba(16,185,129,0.10);
            --available-border: rgba(16,185,129,0.45);
            --holiday-bg: rgba(14,165,233,0.08);

            --timeline-width: 56px;
            --hour-height: 48px; /* 1 saat = 48px, 15dk = 12px */
            --column-min: 200px; /* ~5% narrower */
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #161616;
                --surface: #191919;
                --text: rgba(255,255,255,0.9);
                --muted: rgba(255,255,255,0.6);
                --border: rgba(255,255,255,0.08);
                --grid-15: rgba(255,255,255,0.05);
                --grid-60: rgba(255,255,255,0.12);
                --available-bg: rgba(16,185,129,0.15);
                --available-border: rgba(16,185,129,0.5);
                --holiday-bg: rgba(14,165,233,0.12);
            }
        }

        body { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; color: var(--text); background: var(--bg); }
        .page { min-height: 100dvh; padding: clamp(8px, 1.5dvh, 16px); display: flex; flex-direction: column; gap: 6px; }

        .calendar-shell { border: 1.5px solid var(--border); border-radius: 14px; overflow: hidden; background: var(--surface); display: grid; grid-template-columns: var(--timeline-width) 1fr; box-shadow: var(--elev-1); }

        .day-headers { display: grid; grid-template-columns: repeat(7, minmax(var(--column-min), 1fr)); position: sticky; top: 0; z-index: 5; background: var(--surface); border-bottom: 1.5px solid var(--border); }
        .day-header { padding: 8px 8px; text-align: center; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); font-size: 10px; }
        .day-header.empty { color: #0891b2; opacity: .9; }

        .timeline { position: relative; }
        .timeline-header { position: sticky; top: 0; height: 34px; background: var(--surface); border-right: 1.5px solid var(--border); }
        .time-grid { position: relative; height: calc(var(--hour-height) * 15); }
        .time-label { position: absolute; left: 0; width: 100%; text-align: right; padding-right: 6px; color: var(--muted); font-size: 9.5px; font-weight: 700; transform: translateY(-50%); }

        .days-container { overflow: auto; position: relative; }
        .days { position: relative; display: grid; grid-template-columns: repeat(7, minmax(var(--column-min), 1fr)); }
        .day { position: relative; height: calc(var(--hour-height) * 15); border-right: 1px solid var(--border); }
        .day:last-child { border-right: none; }
        .day.empty { background: var(--holiday-bg); }

        .day::before { content: ""; position: absolute; inset: 0; background:
            repeating-linear-gradient(to bottom,
                var(--grid-15) 0 1px, transparent 1px calc(var(--hour-height)/4),
                transparent calc(var(--hour-height)/4) calc(var(--hour-height)/4 + 1px),
                var(--grid-15) calc(var(--hour-height)/4) calc(var(--hour-height)/2),
                var(--grid-60) calc(var(--hour-height)/2) calc(var(--hour-height)/2 + 1px),
                transparent calc(var(--hour-height)/2 + 1px) calc(var(--hour-height)*3/4),
                var(--grid-15) calc(var(--hour-height)*3/4) calc(var(--hour-height)*3/4 + 1px),
                transparent calc(var(--hour-height)*3/4 + 1px) var(--hour-height)
            ); pointer-events: none; }

        .event { position: absolute; left: 6px; right: 6px; border-radius: 9px; color: #fff; font-weight: 800; letter-spacing: .01em; box-shadow: 0 3px 14px rgba(0,0,0,.18); display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px 6px; font-size: 10.6px; line-height: 1.1; user-select: none; }
        .event:hover { transform: translateY(-1px); box-shadow: 0 8px 22px rgba(0,0,0,.22); }

        .available { background: var(--available-bg); border: 2px dashed var(--available-border); color: var(--accent-green); box-shadow: none; }
        .event.s0 { background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-dark)); }
        .event.s1 { background: linear-gradient(135deg, var(--accent-green), var(--accent-green-dark)); }
        .event.s2 { background: linear-gradient(135deg, var(--accent-purple), var(--accent-purple-dark)); }
        .event.s3 { background: linear-gradient(135deg, var(--accent-orange), var(--accent-orange-dark)); }
        .event.s4 { background: linear-gradient(135deg, var(--accent-pink), var(--accent-pink-dark)); }
        .event.s5 { background: linear-gradient(135deg, var(--accent-teal), var(--accent-teal-dark)); }
        .event.s6 { background: linear-gradient(135deg, var(--accent-indigo), var(--accent-indigo-dark)); }
        .event.s7 { background: linear-gradient(135deg, var(--accent-red), var(--accent-red-dark)); }
        .event.s8 { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-cyan-dark)); }
        .event.s9 { background: linear-gradient(135deg, #a855f7, #9333ea); }

        .event[data-columns] { width: calc((100% - 12px) / var(--cols)); left: calc(6px + (var(--track) * (100% - 12px) / var(--cols))); right: auto; }

        .nav-btn { display: none; position: absolute; top: 50%; transform: translateY(-50%); height: 32px; width: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface); box-shadow: var(--elev-1); color: var(--text); font-weight: 900; font-size: 18px; align-items: center; justify-content: center; cursor: pointer; z-index: 6; }
        .nav-left { left: 6px; }
        .nav-right { right: 6px; }

        @media (max-width: 900px) {
            :root { --column-min: 190px; --timeline-width: 52px; --hour-height: 46px; }
            .event { font-size: 10.2px; padding: 4px 6px; }
        }
        @media (max-width: 560px) {
            :root { --column-min: 170px; --hour-height: 44px; }
            .event { font-size: 9.8px; border-radius: 8px; }
            .nav-btn { display: none; }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="calendar-shell">
            <div class="timeline">
                <div class="timeline-header"></div>
                <div id="timeline" class="time-grid"></div>
            </div>
            <div class="days-container">
                <div id="dayHeaders" class="day-headers"></div>
                <div id="days" class="days"></div>
                <div class="nav-btn nav-left" onclick="prevDay()" title="Önceki Gün">‹</div>
                <div class="nav-btn nav-right" onclick="nextDay()" title="Sonraki Gün">›</div>
            </div>
        </div>
    </div>

    <script>
        // Read connection details from URL
        function getUrlParams(){
            const p = new URLSearchParams(window.location.search);
            return { key: p.get('key'), endpoint: p.get('endpoint') };
        }
        function decodeEndpoint(value){
            if(!value) return null;
            try {
                const decoded = atob(value);
                if(decoded.startsWith('http')) return decoded;
            } catch {}
            // accept raw URL too
            if(value.startsWith('http')) return value;
            return null;
        }

        const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
        const DAY_TR = { Monday:'Pazartesi', Tuesday:'Salı', Wednesday:'Çarşamba', Thursday:'Perşembe', Friday:'Cuma', Saturday:'Cumartesi', Sunday:'Pazar' };

        const START_MIN = 8*60;  // 08:00
        const END_MIN = 23*60;   // 23:00
        const HOUR_HEIGHT = () => parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hour-height'));
        const PX_PER_MIN = () => HOUR_HEIGHT()/60;

        function qs(sel,root=document){return root.querySelector(sel)}
        function qsa(sel,root=document){return Array.from(root.querySelectorAll(sel))}
        function timeFromISO(iso){ const d=new Date(iso); return d.getHours()*60+d.getMinutes(); }
        function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
        function minutesToHHMM(m){ const h=Math.floor(m/60); const mm=m%60; return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
        function isMobileOneDay(){ return window.innerWidth <= 560; }

        let activeDayIndex = 0;

        function buildStaticUI(){
            const tl = qs('#timeline');
            tl.innerHTML = '';
            for(let m=START_MIN; m<=END_MIN; m+=30){
                const top = (m-START_MIN)*PX_PER_MIN();
                const isHour = m%60===0;
                const label = `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = 'time-label';
                el.style.top = `${top}px`;
                el.style.fontWeight = isHour? '800' : '700';
                el.style.opacity = isHour? '1' : '.75';
                el.textContent = label;
                tl.appendChild(el);
            }
        }

        const studentColor = new Map(); let colorIdx = 0;
        function hueFromString(str){ let h=0; for(let i=0;i<str.length;i++){ h = (h*31 + str.charCodeAt(i)) % 360; } return h; }
        function gradientForStudent(studentArr){
            const id = (studentArr && studentArr[0]) || 'default';
            if(!studentColor.has(id)) studentColor.set(id, hueFromString(id));
            const h = studentColor.get(id);
            const h2 = (h + 12) % 360;
            return `linear-gradient(135deg, hsl(${h}, 85%, 55%), hsl(${h2}, 85%, 45%))`;
        }

        function applyMobileActiveClasses(){
            const headers = qsa('.day-header');
            const cols = qsa('.day');
            headers.forEach((h,i)=>h.classList.toggle('active', i===activeDayIndex));
            cols.forEach((c,i)=>c.classList.toggle('active', i===activeDayIndex));
        }

        function layoutAndRender(sessions){
            const byDay = Object.fromEntries(DAYS.map(d => [d, []]));
            sessions.forEach(s => {
                if(!s.property_weekday || !s.property_hours) return;
                const start = clamp(timeFromISO(s.property_hours.start), START_MIN, END_MIN);
                const end = clamp(timeFromISO(s.property_hours.end), START_MIN, END_MIN);
                if(end<=start) return;
                byDay[s.property_weekday].push({ ...s, start, end });
            });

            const empties = DAYS.map(d => byDay[d].length === 0);
            qs('#dayHeaders').innerHTML = DAYS.map((d,i) => `<div class="day-header ${empties[i]?'empty':''}">${DAY_TR[d]}</div>`).join('');
            qs('#days').innerHTML = DAYS.map((_,i) => `<div class="day ${empties[i]?'empty':''}"></div>`).join('');

            // Column widths: empty days narrower (extra-narrow on mobile)
            const isMobile = window.innerWidth <= 560;
            const cols = DAYS.map((d,i) => {
                if (isMobile) {
                    return empties[i] ? '44px' : 'minmax(var(--column-min), var(--column-min))';
                }
                return empties[i] ? 'minmax(44px, 0.24fr)' : 'minmax(var(--column-min), 1fr)';
            }).join(' ');
            qs('#dayHeaders').style.gridTemplateColumns = cols;
            qs('#days').style.gridTemplateColumns = cols;

            const columns = qsa('.day', qs('#days'));
            DAYS.forEach((day, dayIdx) => {
                const list = byDay[day].sort((a,b)=>a.start-b.start);
                const tracks = [];
                const laid = list.map(evt => { let track=0; while(tracks[track] && tracks[track] > evt.start) track++; tracks[track]=evt.end; return { evt, track }; });
                const colsCount = Math.max(1, tracks.length);
                const col = columns[dayIdx]; col.innerHTML='';
                laid.forEach(({evt, track}) => {
                    const top = (evt.start-START_MIN)*PX_PER_MIN();
                    const height = (evt.end-evt.start)*PX_PER_MIN();
                    const isAvailable = (evt.name||'').trim().toUpperCase().startsWith('AVAILABLE');
                    const name = isAvailable ? 'Müsait' : (evt.name.split('(')[0]||'').trim();
                    const durationMin = evt.end - evt.start;
                    const label = `${name} (${minutesToHHMM(evt.start)}–${minutesToHHMM(evt.end)})`;
                    const tip = `${DAY_TR[day]} • ${minutesToHHMM(evt.start)}–${minutesToHHMM(evt.end)} (${durationMin} dk)`;
                    const div = document.createElement('div');
                    div.className = `event ${isAvailable? 'available' : ''}`;
                    if(!isAvailable){ div.style.background = gradientForStudent(evt.property_student); }
                    if(colsCount>1){ div.dataset.columns = String(colsCount); div.style.setProperty('--cols', colsCount); div.style.setProperty('--track', track); }
                    div.style.top = `${top+2}px`;
                    div.style.height = `${Math.max(18, height-4)}px`;
                    div.textContent = label;
                    div.title = tip;
                    col.appendChild(div);
                });
            });

            if(isMobileOneDay()) applyMobileActiveClasses();
        }

        async function fetchData(){
            const { key, endpoint } = getUrlParams();
            const url = decodeEndpoint(endpoint);
            if(!key || !url){
                qs('#days').innerHTML = '<div style="padding:12px;color:var(--muted);">Erişim reddedildi</div>';
                qs('#dayHeaders').innerHTML = '';
                return;
            }
            try {
                let res;
                try {
                    res = await fetch(url, { headers: { 'Authorization': `Basic ${key}` } });
                } catch (e) {
                    const proxy = `https://thingproxy.freeboard.io/fetch/${url}`;
                    res = await fetch(proxy, { headers: { 'Authorization': `Basic ${key}` } });
                }
                if(!res.ok) throw new Error('Network');
                const data = await res.json();
                layoutAndRender(data);
            } catch (e) {
                qs('#days').innerHTML = '<div style="padding:12px;color:#dc2626;">Veri yüklenemedi</div>';
                qs('#dayHeaders').innerHTML = '';
            }
        }

        function prevDay(){ activeDayIndex = (activeDayIndex + 6) % 7; applyMobileActiveClasses(); }
        function nextDay(){ activeDayIndex = (activeDayIndex + 1) % 7; applyMobileActiveClasses(); }

        buildStaticUI();
        fetchData();
        window.addEventListener('resize', () => { buildStaticUI(); fetchData(); });
    </script>
</body>
</html>
